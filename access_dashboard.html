<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Acceso en Tiempo Real</title>
    <!-- Incluir Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .dashboard-card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .user-item {
            transition: background-color 0.2s;
            border-bottom: 1px solid #eee;
        }
        .user-item:last-child {
            border-bottom: none;
        }
    </style>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, collection, query, limit, onSnapshot
        };
    </script>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-start justify-center">

    <div class="w-full max-w-4xl mt-10">
        <h1 class="text-4xl font-black text-indigo-700 mb-6 text-center drop-shadow-sm">
            üìà Panel de Control de Acceso 
        </h1>
        <p class="text-center text-gray-500 mb-8">Visualizaci√≥n en tiempo real de los usuarios que han cargado la aplicaci√≥n de juego.</p>

        <div class="dashboard-card p-6">
            <h2 class="text-2xl font-bold text-indigo-800 mb-4 border-b pb-2 flex justify-between items-center">
                √öltimos 10 Accesos al Juego
                <span id="auth-status" class="text-sm font-semibold text-gray-500">Cargando...</span>
            </h2>
            
            <div id="user-list-container" class="max-h-[500px] overflow-y-auto">
                <ul id="user-list" class="divide-y divide-gray-100">
                    <li class="p-3 text-gray-400">Esperando datos de Firebase...</li>
                </ul>
            </div>
            
        </div>
        
        <p class="text-sm text-center text-gray-400 mt-6">
            El ID de usuario es un identificador √∫nico asignado a cada sesi√≥n.
        </p>
    </div>

    <script>
        // --- CONSTANTES GLOBALES DE FIREBASE ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db = null;
        let isAuthReady = false;

        const authStatusElement = document.getElementById('auth-status');
        const userListElement = document.getElementById('user-list');

        // Determina la ruta de la colecci√≥n p√∫blica para el registro de acceso
        // DEBE COINCIDIR con la ruta usada en el archivo english_game.html
        const accessLogPath = `artifacts/${appId}/public/data/access_logs`;

        // --- FIREBASE LOGIC for Access Dashboard ---

        /**
         * Configura el listener de tiempo real para mostrar los √∫ltimos 10 usuarios.
         */
        function setupAccessLogListener() {
            if (!db || !isAuthReady) return;

            const logsCollectionRef = firebase.collection(db, accessLogPath);
            
            // Limitamos a 20 documentos para tener suficiente para ordenar.
            const q = firebase.query(logsCollectionRef, firebase.limit(20)); 

            // Escuchar cambios en tiempo real
            firebase.onSnapshot(q, (snapshot) => {
                const users = [];
                snapshot.forEach((doc) => {
                    users.push(doc.data());
                });

                // Ordenar en el cliente (JavaScript) por lastAccess, de m√°s reciente a m√°s antiguo
                users.sort((a, b) => {
                    // Manejar Firestore Timestamps (pueden ser nulos o objetos)
                    const timeA = a.lastAccess?.toDate ? a.lastAccess.toDate().getTime() : 0;
                    const timeB = b.lastAccess?.toDate ? b.lastAccess.toDate().getTime() : 0;
                    return timeB - timeA; // M√°s reciente primero
                });
                
                // Solo mostrar los √∫ltimos 10 despu√©s de ordenar
                renderUserList(users.slice(0, 10)); 

            }, (error) => {
                console.error("Error listening to user access logs:", error);
                userListElement.innerHTML = `<li class="p-3 text-red-500">Error al cargar la lista: ${error.message}</li>`;
            });
        }

        /**
         * Renderiza la lista de usuarios.
         * @param {Array<Object>} users - Lista de objetos de usuario con userId y lastAccess.
         */
        function renderUserList(users) {
            userListElement.innerHTML = '';
            if (users.length === 0) {
                userListElement.innerHTML = '<li class="p-3 text-gray-500">A√∫n no hay registros de acceso. Pide a alguien que cargue el juego.</li>';
                return;
            }

            users.forEach(user => {
                const li = document.createElement('li');
                li.classList.add('p-3', 'flex', 'flex-col', 'sm:flex-row', 'justify-between', 'user-item', 'hover:bg-indigo-50');

                // Formatear la hora de acceso
                const lastAccessTime = user.lastAccess?.toDate ? user.lastAccess.toDate().toLocaleTimeString() : 'N/A';
                const lastAccessDate = user.lastAccess?.toDate ? user.lastAccess.toDate().toLocaleDateString() : 'N/A';
                
                li.innerHTML = `
                    <div class="font-mono text-base text-indigo-900 break-all">
                        <span class="font-bold mr-2">ID:</span>${user.userId}
                    </div>
                    <div class="text-xs text-gray-600 mt-1 sm:mt-0">
                        <span class="font-semibold">√öltimo Acceso:</span> ${lastAccessDate} ${lastAccessTime}
                    </div>
                `;
                userListElement.appendChild(li);
            });
        }

        // --- FIREBASE INITIALIZATION ---
        async function initFirebaseAndAuth() {
            if (!firebaseConfig) {
                authStatusElement.textContent = "Error: Configuraci√≥n de Firebase no encontrada.";
                return;
            }

            try {
                const app = firebase.initializeApp(firebaseConfig);
                db = firebase.getFirestore(app);
                const auth = firebase.getAuth(app);
                
                authStatusElement.textContent = "Conectando...";

                // Autenticaci√≥n (solo necesitamos autenticaci√≥n para leer datos p√∫blicos)
                if (initialAuthToken) {
                    await firebase.signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await firebase.signInAnonymously(auth);
                }
                
                firebase.onAuthStateChanged(auth, (user) => {
                    if (user) {
                        isAuthReady = true;
                        authStatusElement.innerHTML = `‚úÖ <span class="text-green-600">Conectado</span>`;
                        setupAccessLogListener(); // Iniciar la escucha
                    } else {
                        isAuthReady = true;
                        authStatusElement.innerHTML = `‚ùå <span class="text-red-600">Desconectado</span>`;
                        userListElement.innerHTML = '<li class="p-3 text-red-500">Error: No se pudo establecer la conexi√≥n de lectura.</li>';
                    }
                });

            } catch (error) {
                console.error("Firebase/Auth Initialization Error:", error);
                authStatusElement.textContent = `Error de conexi√≥n: ${error.message}`;
            }
        }

        // --- Inicializaci√≥n ---
        document.addEventListener('DOMContentLoaded', initFirebaseAndAuth);
    </script>
</body>
</html>