<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Acceso en Tiempo Real</title>
    <!-- Incluir Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos CSS del dashboard */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        .dashboard-card { background-color: #ffffff; border-radius: 1rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .user-item { transition: background-color 0.2s; border-bottom: 1px solid #eee; }
        .user-item:last-child { border-bottom: none; }
    </style>
    <!-- Firebase Imports: Importaciones necesarias para AUTH y Firestore (LECTURA) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged,
            getFirestore, collection, query, limit, onSnapshot
        };
    </script>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-start justify-center">

    <div class="w-full max-w-4xl mt-10">
        <h1 class="text-4xl font-black text-indigo-700 mb-6 text-center drop-shadow-sm">
            üìà Panel de Control de Acceso (Tiempo Real)
        </h1>
        <p class="text-center text-gray-500 mb-8">
            Usuarios que han cargado la aplicaci√≥n de juego. Los datos se actualizan autom√°ticamente.
        </p>

        <!-- ** INSTRUCCIONES IMPORTANTES DE CONFIGURACI√ìN ** -->
        <div id="config-warning" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 rounded" role="alert">
            <p class="font-bold">¬°IMPORTANTE PARA SITIOS EXTERNOS (GitHub Pages)!</p>
            <p class="text-sm">Debes reemplazar los valores de `YOUR_API_KEY`, `YOUR_AUTH_DOMAIN`, etc., con los valores de configuraci√≥n de tu proyecto de Firebase en la secci√≥n `FIREBASE_CONFIG` del c√≥digo.</p>
        </div>

        <div class="dashboard-card p-6">
            <h2 class="text-2xl font-bold text-indigo-800 mb-4 border-b pb-2 flex justify-between items-center">
                √öltimos 10 Accesos al Juego
                <span id="auth-status" class="text-sm font-semibold text-gray-500">Cargando...</span>
            </h2>
            
            <div id="user-list-container" class="max-h-[500px] overflow-y-auto">
                <ul id="user-list" class="divide-y divide-gray-100">
                    <li class="p-3 text-gray-400">Esperando conexi√≥n a Firebase...</li>
                </ul>
            </div>
            
        </div>
        
        <p class="text-sm text-center text-gray-400 mt-6">
            El ID de usuario es un identificador √∫nico generado por la sesi√≥n de Firebase.
        </p>
    </div>

    <script>
        // ====================================================================
        // === PASO 1: CONFIGURACI√ìN PARA SITIOS EXTERNOS (COPIA TUS CLAVES) ===
        // ====================================================================
        
        // üö® REEMPLAZA ESTOS VALORES CON LAS CLAVES DE TU PROYECTO DE FIREBASE üö®
        const FIREBASE_CONFIG = {
            apiKey: "YOUR_API_KEY", 
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        // El 'appId' usado para la ruta de la base de datos (generalmente el projectId)
        const DATABASE_APP_ID = FIREBASE_CONFIG.projectId; 
        
        // ====================================================================
        
        let db = null;
        let isAuthReady = false;

        const authStatusElement = document.getElementById('auth-status');
        const userListElement = document.getElementById('user-list');
        const configWarningElement = document.getElementById('config-warning');

        // La ruta DEBE COINCIDIR con la ruta usada en el archivo english_game.html
        const accessLogPath = `artifacts/${DATABASE_APP_ID}/public/data/access_logs`;

        // --- FIREBASE LOGIC for Access Dashboard (L√≥gica para el Dashboard) ---

        function setupAccessLogListener() {
            if (!db || !isAuthReady) return;
            authStatusElement.innerHTML = `‚úÖ <span class="text-green-600">Conectado y Escuchando...</span>`;
            configWarningElement.classList.add('hidden'); // Ocultar si la conexi√≥n fue exitosa

            const logsCollectionRef = firebase.collection(db, accessLogPath);
            
            // Limitamos a 20 documentos para ordenar localmente.
            const q = firebase.query(logsCollectionRef, firebase.limit(20)); 

            // Escuchar cambios en tiempo real
            firebase.onSnapshot(q, (snapshot) => {
                const users = [];
                snapshot.forEach((doc) => {
                    users.push(doc.data());
                });

                // Ordenar en el cliente (JavaScript) por lastAccess, de m√°s reciente a m√°s antiguo
                users.sort((a, b) => {
                    // Manejo seguro de Firestore Timestamps
                    const timeA = a.lastAccess?.toDate ? a.lastAccess.toDate().getTime() : 0;
                    const timeB = b.lastAccess?.toDate ? b.lastAccess.toDate().getTime() : 0;
                    return timeB - timeA;
                });
                
                // Mostrar solo los √∫ltimos 10
                renderUserList(users.slice(0, 10)); 

            }, (error) => {
                console.error("Error al escuchar los registros de acceso. Verifique las Reglas de Seguridad.", error);
                // Mostrar un mensaje de error m√°s claro en la UI
                userListElement.innerHTML = `<li class="p-3 text-red-500 font-bold">‚ùå Error de LECTURA: Permiso denegado. <br>Aseg√∫rate de que las Reglas de Seguridad (firestore.rules) permitan la lectura.</li>`;
            });
        }

        function renderUserList(users) {
            userListElement.innerHTML = '';
            if (users.length === 0) {
                userListElement.innerHTML = '<li class="p-3 text-gray-500">A√∫n no hay registros de acceso.</li>';
                return;
            }

            users.forEach(user => {
                const li = document.createElement('li');
                li.classList.add('p-3', 'flex', 'flex-col', 'sm:flex-row', 'justify-between', 'user-item', 'hover:bg-indigo-50');

                // Formateo seguro de la hora de acceso
                const lastAccessTime = user.lastAccess?.toDate ? user.lastAccess.toDate().toLocaleTimeString('es-ES') : 'N/A';
                const lastAccessDate = user.lastAccess?.toDate ? user.lastAccess.toDate().toLocaleDateString('es-ES') : 'N/A';
                
                li.innerHTML = `
                    <div class="font-mono text-sm text-indigo-900 break-all flex items-center">
                        <span class="font-bold text-base mr-2">üë§</span> ${user.userId}
                    </div>
                    <div class="text-xs text-gray-600 mt-1 sm:mt-0">
                        <span class="font-semibold text-indigo-700">Acceso:</span> ${lastAccessDate} ${lastAccessTime}
                    </div>
                `;
                userListElement.appendChild(li);
            });
        }

        // --- FIREBASE INITIALIZATION (Inicializaci√≥n de Firebase) ---
        async function initFirebaseAndAuth() {
            // Comprobaci√≥n b√°sica de configuraci√≥n
            if (FIREBASE_CONFIG.apiKey === "YOUR_API_KEY") {
                authStatusElement.textContent = "Error CR√çTICO: Claves de configuraci√≥n de Firebase no actualizadas.";
                userListElement.innerHTML = '<li class="p-3 text-red-700 font-bold">Error Cr√≠tico: Actualiza los valores de FIREBASE_CONFIG.</li>';
                return;
            }

            try {
                const app = firebase.initializeApp(FIREBASE_CONFIG);
                db = firebase.getFirestore(app);
                const auth = firebase.getAuth(app);
                
                authStatusElement.textContent = "Conectando y Autenticando...";
                
                // Usamos signInAnonymously directamente para sitios est√°ticos.
                await firebase.signInAnonymously(auth);

                firebase.onAuthStateChanged(auth, (user) => {
                    if (user) {
                        isAuthReady = true;
                        // Si la autenticaci√≥n funciona, procedemos a leer los datos.
                        setupAccessLogListener();
                    } else {
                        isAuthReady = true;
                        authStatusElement.innerHTML = `‚ùå <span class="text-red-600">Autenticaci√≥n Fallida</span>`;
                        userListElement.innerHTML = '<li class="p-3 text-red-500">Error: El usuario no pudo autenticarse con Firebase. Aseg√∫rate que la autenticaci√≥n an√≥nima est√© activada.</li>';
                    }
                });

            } catch (error) {
                console.error("Error grave de Inicializaci√≥n de Firebase:", error);
                authStatusElement.textContent = `Error cr√≠tico de conexi√≥n: ${error.message}`;
            }
        }

        document.addEventListener('DOMContentLoaded', initFirebaseAndAuth);
    </script>
</body>
</html>
